<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">
<head>
  <meta charset="utf-8" />
  <meta name="generator" content="pandoc" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
  <title>GoogleAsAnIdentityProvider</title>
  <style>
    html {
      color: #1a1a1a;
      background-color: #fdfdfd;
    }
    body {
      margin: 0 auto;
      max-width: 36em;
      padding-left: 50px;
      padding-right: 50px;
      padding-top: 50px;
      padding-bottom: 50px;
      hyphens: auto;
      overflow-wrap: break-word;
      text-rendering: optimizeLegibility;
      font-kerning: normal;
    }
    @media (max-width: 600px) {
      body {
        font-size: 0.9em;
        padding: 12px;
      }
      h1 {
        font-size: 1.8em;
      }
    }
    @media print {
      html {
        background-color: white;
      }
      body {
        background-color: transparent;
        color: black;
        font-size: 12pt;
      }
      p, h2, h3 {
        orphans: 3;
        widows: 3;
      }
      h2, h3, h4 {
        page-break-after: avoid;
      }
    }
    p {
      margin: 1em 0;
    }
    a {
      color: #1a1a1a;
    }
    a:visited {
      color: #1a1a1a;
    }
    img {
      max-width: 100%;
    }
    h1, h2, h3, h4, h5, h6 {
      margin-top: 1.4em;
    }
    h5, h6 {
      font-size: 1em;
      font-style: italic;
    }
    h6 {
      font-weight: normal;
    }
    ol, ul {
      padding-left: 1.7em;
      margin-top: 1em;
    }
    li > ol, li > ul {
      margin-top: 0;
    }
    blockquote {
      margin: 1em 0 1em 1.7em;
      padding-left: 1em;
      border-left: 2px solid #e6e6e6;
      color: #606060;
    }
    code {
      font-family: Menlo, Monaco, Consolas, 'Lucida Console', monospace;
      font-size: 85%;
      margin: 0;
      hyphens: manual;
    }
    pre {
      margin: 1em 0;
      overflow: auto;
    }
    pre code {
      padding: 0;
      overflow: visible;
      overflow-wrap: normal;
    }
    .sourceCode {
     background-color: transparent;
     overflow: visible;
    }
    hr {
      background-color: #1a1a1a;
      border: none;
      height: 1px;
      margin: 1em 0;
    }
    table {
      margin: 1em 0;
      border-collapse: collapse;
      width: 100%;
      overflow-x: auto;
      display: block;
      font-variant-numeric: lining-nums tabular-nums;
    }
    table caption {
      margin-bottom: 0.75em;
    }
    tbody {
      margin-top: 0.5em;
      border-top: 1px solid #1a1a1a;
      border-bottom: 1px solid #1a1a1a;
    }
    th {
      border-top: 1px solid #1a1a1a;
      padding: 0.25em 0.5em 0.25em 0.5em;
    }
    td {
      padding: 0.125em 0.5em 0.25em 0.5em;
    }
    header {
      margin-bottom: 4em;
      text-align: center;
    }
    #TOC li {
      list-style: none;
    }
    #TOC ul {
      padding-left: 1.3em;
    }
    #TOC > ul {
      padding-left: 0;
    }
    #TOC a:not(:hover) {
      text-decoration: none;
    }
    code{white-space: pre-wrap;}
    span.smallcaps{font-variant: small-caps;}
    div.columns{display: flex; gap: min(4vw, 1.5em);}
    div.column{flex: auto; overflow-x: auto;}
    div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
    ul.task-list{list-style: none;}
    ul.task-list li input[type="checkbox"] {
      width: 0.8em;
      margin: 0 0.8em 0.2em -1.6em;
      vertical-align: middle;
    }
    .display.math{display: block; text-align: center; margin: 0.5rem auto;}
    /* CSS for syntax highlighting */
    pre > code.sourceCode { white-space: pre; position: relative; }
    pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
    pre > code.sourceCode > span:empty { height: 1.2em; }
    .sourceCode { overflow: visible; }
    code.sourceCode > span { color: inherit; text-decoration: inherit; }
    div.sourceCode { margin: 1em 0; }
    pre.sourceCode { margin: 0; }
    @media screen {
    div.sourceCode { overflow: auto; }
    }
    @media print {
    pre > code.sourceCode { white-space: pre-wrap; }
    pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
    }
    pre.numberSource code
      { counter-reset: source-line 0; }
    pre.numberSource code > span
      { position: relative; left: -4em; counter-increment: source-line; }
    pre.numberSource code > span > a:first-child::before
      { content: counter(source-line);
        position: relative; left: -1em; text-align: right; vertical-align: baseline;
        border: none; display: inline-block;
        -webkit-touch-callout: none; -webkit-user-select: none;
        -khtml-user-select: none; -moz-user-select: none;
        -ms-user-select: none; user-select: none;
        padding: 0 4px; width: 4em;
        color: #aaaaaa;
      }
    pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
    div.sourceCode
      {   }
    @media screen {
    pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
    }
    code span.al { color: #ff0000; font-weight: bold; } /* Alert */
    code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
    code span.at { color: #7d9029; } /* Attribute */
    code span.bn { color: #40a070; } /* BaseN */
    code span.bu { color: #008000; } /* BuiltIn */
    code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
    code span.ch { color: #4070a0; } /* Char */
    code span.cn { color: #880000; } /* Constant */
    code span.co { color: #60a0b0; font-style: italic; } /* Comment */
    code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
    code span.do { color: #ba2121; font-style: italic; } /* Documentation */
    code span.dt { color: #902000; } /* DataType */
    code span.dv { color: #40a070; } /* DecVal */
    code span.er { color: #ff0000; font-weight: bold; } /* Error */
    code span.ex { } /* Extension */
    code span.fl { color: #40a070; } /* Float */
    code span.fu { color: #06287e; } /* Function */
    code span.im { color: #008000; font-weight: bold; } /* Import */
    code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
    code span.kw { color: #007020; font-weight: bold; } /* Keyword */
    code span.op { color: #666666; } /* Operator */
    code span.ot { color: #007020; } /* Other */
    code span.pp { color: #bc7a00; } /* Preprocessor */
    code span.sc { color: #4070a0; } /* SpecialChar */
    code span.ss { color: #bb6688; } /* SpecialString */
    code span.st { color: #4070a0; } /* String */
    code span.va { color: #19177c; } /* Variable */
    code span.vs { color: #4070a0; } /* VerbatimString */
    code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
  </style>
  <!--[if lt IE 9]>
    <script src="//cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7.3/html5shiv-printshiv.min.js"></script>
  <![endif]-->
</head>
<body>
<h1
id="google-as-an-authentication-provider-for-a-client-server-application">Google
as an Authentication Provider for a Client-Server Application</h1>
<p>Recently, the Innovations Studio at Flatirons Digital Innovations has
been hard at work revamping the authentication handling of our custom
archive solution, Digital Hub. For the first pass of these changes,
Google was added as an identity provider.</p>
<p>Digital Hub has a configuration-based React user interface and a
NodeJS backend server that manages the flow of data between the
datastore and the React frontend. While the Google OIDC documentation is
extensive, I didn’t find anything that provided an end-to-end example,
detailing the steps for authenticating both the client and the server.
There were subtleties in both the client and server setup that were only
discovered after hours of stepping through in a debugger and reading
very old forum posts. The following is a summary of lessons learned that
will hopefully, save you from those long, painful battles.</p>
<p>The complete repository is available at <a
href="https://github.com/fdiinc/google-oidc-blog">https://github.com/fdiinc/google-oidc-blog</a>.</p>
<h2 id="prerequisites">Prerequisites</h2>
<ul>
<li>An understanding of the basics of Open ID Connect (OIDC) and OAuth
2.0 is required to make the best use of this information. There are many
excellent resources on the web that explain both of these concepts, so
this article will not spend time on those details.</li>
<li>A Google Cloud account is needed to configure Google as an identity
provider for the sample application.</li>
<li>General knowledge of Javascript development, React and NodeJS.</li>
<li>Familiarity with the layout and flow of projects created by <a
href="https://create-react-app.dev/docs/getting-started">create-react-app</a>
and <a
href="https://expressjs.com/en/starter/generator.html">expressjs-generator</a>
is helpful, since the frontend and backend projects were generated using
those tools.</li>
</ul>
<h2 id="background">Background</h2>
<p>While all the details of OIDC are outside the scope of this post,
there is one important distinction to make before getting down to the
nitty gritty. OIDC can broadly be broken into two different use cases:
resource management and user management. This post focuses on the user
management case, but due to the prevalence of information that focuses
on how OIDC is used to improve resource management and security, it
seemed important to take a moment and highlight the differences.</p>
<h3 id="resource-management">Resource Management</h3>
<p>When OIDC is used for resource management, the resource owner is able
to grant limited resource access to third-party applications. Consider
the need to print photos stored in the cloud from a pay-to-print kiosk.
Instead of requiring users to give their credentials directly to the
kiosk (which would allow the kiosk full access to the user’s cloud
account), OIDC allows a token to be generated that’s scoped to 1) the
third-party application 2) the user 3) (only) their photos 4) a short
time period. If the third party attempted to access a different scope
(like the user’s email) with that token, the request would be rejected.
The value of this use case is in providing access to user-owned
resources <strong>WITHOUT</strong> the third-party application ever
having access to the user’s cloud credentials.</p>
<p>For good reason, using OIDC for resource management is the focus of
many articles and much documentation; however, even though there is an
overlap in the terminology, the resource management use case is very
different from the user management use case, and the prevalence of
resource management documentation can create confusion when attempting
to implement user management through an OIDC identity provider.</p>
<h3 id="user-management">User Management</h3>
<p>When the OIDC protocol is used in conjunction with an identity
provider (where “identity provider” is an application that the user has
previously registered with e.g. Google), the identity provider takes on
all the responsibility of user management: authenticating credentials,
resetting lost passwords, deleting accounts, etc. The application
utilizing the identity provider can impose some restrictions, such as
blocking specific accounts or domains, but the application itself,
similar to the resource management case, is <strong>NEVER</strong> given
access to the user’s credentials. Again, it’s easy to see the value
here. Users aren’t required to create and keep track of a new account
for the application, and the application developers are able to focus on
application-specific functionality, instead of trying to securely
reinvent the authentication wheel.</p>
<p>The rest of this article is going to focus on using Google as an
identity provider, for a Javascript-based client-server application.</p>
<h2 id="goal">Goal</h2>
<p>To demonstrate the configuration required to use Google as an
identity provider, we will be creating a small application, that
displays both restricted and unrestricted content to users, as
appropriate. The goals of this application are to:</p>
<ul>
<li>create a client-server application that runs locally (i.e. doesn’t
required external hosting).</li>
<li>use Google for user authentication.</li>
<li>block unauthenticated users from accessing restricted content (by
both frontend and backend controls) and only allow them to view public
content.</li>
<li>allow authenticated users the option to view restricted
content.</li>
</ul>
<h2 id="overview">Overview</h2>
<p>Multiple steps are required to use Google as an identity provider for
an application. At a high level, the steps are as follows:</p>
<ul>
<li>Register the application with Google.</li>
<li>Update the frontend of the application.
<ul>
<li>Load the <a
href="https://developers.google.com/identity/gsi/web/guides/overview">gsi
library</a> as a script in the React HTML.</li>
<li>Configure a Google OAuth button (provided by the gsi library).</li>
<li>Utilize the backend to exchange an authorization code for identity
tokens.</li>
</ul></li>
<li>Update the backend of the application.
<ul>
<li>Add the <a
href="https://www.npmjs.com/package/googleapis">googleapis</a> library
(version 126.0.0 is used at time of writing).</li>
<li>Create a new function that will accept an authorization code and
exchange it for Google-issued identity tokens.</li>
<li>Return the identity tokens to the frontend.</li>
<li>Validate the token presence and value on REST requests.</li>
</ul></li>
</ul>
<p>The steps above are done once, around the same time the application
is created. Then, every time a user attempts to authenticate, the
following steps occur:</p>
<ul>
<li>The user clicks the Google OAuth button, causing a dialog to appear
requesting user access.
<ul>
<li>If this is the first time a user has authenticated with the
application, they will be shown the name of the application requesting
access and the scope of access being requested. They will be asked to
allow or deny that access (which can be revoked by the user at any
time).</li>
<li>If the user has previously granted the application access, they will
just need to authenticate with their Google credentials.</li>
</ul></li>
<li>Assuming the user authorized the application and provided valid
credentials, an authorization code is returned to the frontend, which is
valid for 1 hour.</li>
<li>The frontend makes a REST call to <em>login</em> on the backend,
passing the authorization code.</li>
<li>The backend passes the authorization code to Google, where it is
exchanged for identity and access tokens.</li>
<li>The backend passes the tokens to the frontend, and they are used in
the <em>Authorization</em> header for every subsequent REST exchange
between the frontend and backend.</li>
</ul>
<h2 id="application-registration">Application Registration</h2>
<p>In order to use Google as an identity provider for an application, it
is necessary to first register the application with Google.</p>
<h3 id="oauth-2.0-client-id">OAuth 2.0 Client ID</h3>
<p>In this section, the application is registered with Google and a
client id is created, which will be used to identity the application
when it works with Google to authenticate users.</p>
<ul>
<li>Log in to the <a href="https://console.cloud.google.com/">Google
Cloud Console</a>.</li>
<li>Navigate to “APIs &amp; Services” -&gt; “Credentials”.</li>
<li>Select “+ CREATE CREDENTIALS”.</li>
<li>Choose “OAuth client ID”.</li>
<li>For <strong>Application Type</strong>, select <strong>Web
application</strong>
<ul>
<li>Enter a name for the web application. This should be something that
makes it easy to recognize the application.</li>
<li>For <strong>Authorized JavaScript origins</strong>, add the URL of
the frontend server. This is configuring access for CORS. Since the
sample project is expected to run locally, the following should be added
(separately) as authorized origins.
<ul>
<li>http://localhost</li>
<li>http://localhost:3001</li>
</ul></li>
<li>For <strong>Authorized redirect URIs</strong>, add the URLs that the
Google consent screen should redirect to upon a successful login/consent
granted. Since the sample project will run from localhost, leave empty.
<strong>THIS WILL NEED TO BE SET TO “postmessage” PROGRAMMATICALLY, BUT
LEAVE IT BLANK HERE.</strong></li>
</ul></li>
</ul>
<h3 id="oauth-consent-screen">OAuth Consent Screen</h3>
<p>In this section, the consent screen that’s shown the first time a
user accesses the application, is created. <strong>NOTE: It is only
possible to have ONE OAuth consent screen per Google <em>PROJECT</em>.
However, all the fields are editable, so this consent screen can be
reconfigured to be used by a different application.</strong></p>
<ul>
<li>Navigate to “APIs &amp; Services” -&gt; “OAuth Consent Screen”.</li>
<li>For <strong>User Type</strong> select <strong>External</strong>.
This will allow anyone with a Google-registered account to access the
application.</li>
<li>For <strong>Application Name</strong>, choose something that will
make it easy for users to know what’s requesting consent.</li>
<li>For <strong>Publishing Status</strong>, choose <strong>In
Production</strong> to avoid having to enumerate all possible users that
may use the application.</li>
</ul>
<h2 id="frontend">Frontend</h2>
<p>Once the application has been registered with Google, the application
itself has to be configured to use Google as an identity provider. The
frontend React project will be updated by:</p>
<ul>
<li><p>Importing the Google-provided Javascript script.</p></li>
<li><p>Configuring the “Continue with Google” using the client
information generated in the previous section.</p></li>
<li><p>First, add the GSI client script to
<em>react-frontend/public/index.html</em>.</p>
<ul>
<li><p>Inside the <code>&lt;head&gt;</code> element add</p>
<p><code>&lt;script src="https://accounts.google.com/gsi/client" async defer&gt;</code></p></li>
</ul>
<p>Loading this script in the index.html, makes it available on the
global <strong>window</strong> object inside the React project. With the
notation <code>window.google.accounts</code>, it’s possible to access
the script from any .jsx file.</p></li>
<li><p>Next, use the GSI client to configure a button that will handle
displaying the consent/credential form and negotiating with Google to
exchange the user’s consent and credentials for an authorization code.
This has two components:</p>
<ul>
<li>Initialize the oauth2 and id clients.</li>
</ul>
<div class="sourceCode" id="cb1"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> codeClient <span class="op">=</span> <span class="cf">await</span> <span class="bu">window</span><span class="op">?.</span><span class="at">google</span><span class="op">?.</span><span class="at">accounts</span><span class="op">?.</span><span class="at">oauth2</span><span class="op">?.</span><span class="fu">initCodeClient</span>({</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">client_id</span><span class="op">:</span> TODO<span class="op">,</span> <span class="co">// this is created when the application is registered with Google, and is available through the Google Cloud Console</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">callback</span><span class="op">:</span> <span class="kw">function</span>(response<span class="op">,</span> error) <span class="kw">=&gt;</span> {TODO}<span class="op">,</span> <span class="co">// Custom function to handle a successful login</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>  <span class="dt">scope</span><span class="op">:</span> <span class="st">&#39;openid email profile&#39;</span><span class="op">,</span> <span class="co">// Minimum scope required to use Google as an identity provider</span></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>  <span class="dt">ux_mode</span><span class="op">:</span> <span class="st">&#39;popup&#39;</span> <span class="co">// Designates the way confirmation/credential screen will be displayed. Options are &#39;popup&#39; or &#39;redirect&#39;</span></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a><span class="bu">window</span><span class="op">?.</span><span class="at">google</span><span class="op">?.</span><span class="at">accounts</span><span class="op">?.</span><span class="at">id</span><span class="op">?.</span><span class="fu">initialize</span>({</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a>  <span class="dt">client_id</span><span class="op">:</span>  TODO<span class="op">,</span> <span class="co">// this is the same clientId used above</span></span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a>  <span class="dt">grant_type</span><span class="op">:</span> <span class="st">&#39;authorization_code&#39;</span></span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a>})</span></code></pre></div>
<ul>
<li>Configure the Google auth button styling and pass it a React ref to
(eventually) render into. The ref was created in the constructor using
<code>this.myRef = React.createRef()</code>.</li>
</ul>
<div class="sourceCode" id="cb2"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="bu">window</span><span class="op">?.</span><span class="at">google</span><span class="op">?.</span><span class="at">accounts</span><span class="op">?.</span><span class="at">id</span><span class="op">?.</span><span class="fu">renderButton</span>(</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">this</span><span class="op">.</span><span class="at">myRef</span><span class="op">.</span><span class="at">current</span><span class="op">,</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>  {</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>    <span class="dt">theme</span><span class="op">:</span> <span class="st">&#39;outline&#39;</span><span class="op">,</span></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>    <span class="dt">size</span><span class="op">:</span> <span class="st">&#39;large&#39;</span><span class="op">,</span></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>    <span class="dt">type</span><span class="op">:</span> <span class="st">&#39;standard&#39;</span><span class="op">,</span></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>    <span class="dt">text</span><span class="op">:</span> <span class="st">&#39;continue_with&#39;</span></span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>  }<span class="op">,</span></span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>  <span class="co">// This undocumented third parameter is a callback that fires when the credentials dialog is dismissed. After the user provides credentials to &quot;Sign In Using Google&quot; dialog, an authorization code is requested using this parameter.</span></span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a>  <span class="kw">async</span> () <span class="kw">=&gt;</span> <span class="cf">await</span> <span class="kw">this</span><span class="op">.</span><span class="at">state</span><span class="op">.</span><span class="at">client</span><span class="op">.</span><span class="fu">requestCode</span>()</span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div></li>
<li><p>Finally, render the button.</p></li>
</ul>
<div class="sourceCode" id="cb3"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="fu">render</span>() {</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> <span class="op">&lt;</span>div ref<span class="op">=</span>{<span class="kw">this</span><span class="op">.</span><span class="at">myRef</span>} align<span class="op">=</span><span class="st">&quot;center&quot;</span><span class="op">&gt;&lt;/</span>div<span class="op">&gt;</span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>The Google script is responsible for button rendering, displaying the
consent and credential dialogs (as appropriate), and exchanging user
consent and credentials for an authorization code. That’s all out of the
control of the react-frontend project, to ensure that the react-frontend
(as the third-party application) is never given access to user
credentials.</p>
<p>Because the react-frontend designated authorization code as the grant
type during initialization, when user authentication is completed on the
frontend, the frontend has, not an identity or access token (which
contain user-specific information such as name, email, and avatar) but
an authorization code. This code must be exchanged for tokens. To ensure
that the backend and frontend use the same tokens to confirm user
identity, the frontend delegates code &lt;–&gt; token exchange to the
backend.</p>
<p>For the complete example, see react-frontend/src/GoogleAuth.jsx.</p>
<h2 id="backend">Backend</h2>
<p>Finally the backend of the application is updated. At a high level,
the backend is responsible for four steps:</p>
<ul>
<li>Provide a REST endpoint to receive the authorization code.</li>
<li>Negotiate with Google to exchange the authorization code for
user-specific identification tokens.</li>
<li>Return the identification tokens back to the frontend.</li>
<li>Validate the token in the authorization header of every secured REST
endpoint request.</li>
</ul>
<p>However, before executing any of these steps, the backend must also
register with Google.</p>
<ul>
<li><p>In the nodejs-backend project, install the Google-provided NPM
library, “googleapis”
<code>cd nodejs-backend; yarn add googleapis</code>.</p></li>
<li><p>Initialize the Google API library with the same
application-specific information used by the frontend.</p>
<div class="sourceCode" id="cb4"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> oauth2Client <span class="op">=</span> <span class="kw">new</span> google<span class="op">.</span><span class="at">auth</span><span class="op">.</span><span class="fu">OAuth2</span>({</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">clientId</span><span class="op">:</span> TODO<span class="op">,</span> <span class="co">// this is the same clientId used by the frontend</span></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">clientSecret</span><span class="op">:</span> TODO<span class="op">,</span> <span class="co">// this is created when the application is registered with Google, and is available through the Google Cloud Console</span></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>  <span class="dt">redirectUri</span><span class="op">:</span> TODO<span class="op">,</span> <span class="co">// If running locally i.e. on &quot;localhost&quot;, this MUST be postmessage</span></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>  <span class="dt">eagerRefreshThresholdMillis</span><span class="op">:</span> TODO <span class="co">// the threshold for which a token should be considered &quot;expiring&quot; and a refresh request issued</span></span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>})</span></code></pre></div></li>
<li><p>After the Google OAuth client has been registered, it can be used
to exchange the authorization code for identity tokens.</p>
<div class="sourceCode" id="cb5"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> r <span class="op">=</span> <span class="cf">await</span> oauth2Client<span class="op">.</span><span class="fu">getTokenAsync</span>({</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>  code<span class="op">,</span> <span class="co">// Authorization code, provided in the body of the REST request by the frontend</span></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">redirect_uri</span><span class="op">:</span> <span class="st">&#39;postmessage&#39;</span> <span class="co">// Indicates that the server is running on localhost</span></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>})</span></code></pre></div></li>
<li><p>The tokens are set in the OAuth client and encoded into a single
JWT (JSON Web Token) to return to the frontend as the REST response.</p>
<div class="sourceCode" id="cb6"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>oauth2Client<span class="op">.</span><span class="fu">setCredentials</span>(r<span class="op">.</span><span class="at">tokens</span>)</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> body <span class="op">=</span> <span class="fu">makeAuthBody</span>(jwtService<span class="op">,</span> r<span class="op">.</span><span class="at">tokens</span><span class="op">,</span> <span class="st">&#39;Username or password is incorrect&#39;</span>)</span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> resStatus <span class="op">=</span> body<span class="op">.</span><span class="at">success</span> <span class="op">?</span> res <span class="op">:</span> res<span class="op">.</span><span class="fu">status</span>(<span class="dv">401</span>)</span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>resStatus<span class="op">.</span><span class="fu">format</span>({</span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>  <span class="dt">json</span><span class="op">:</span> () <span class="kw">=&gt;</span> {</span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>    res<span class="op">.</span><span class="fu">json</span>(body)</span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a>})</span></code></pre></div></li>
<li><p>Now the only thing left to do is to validate Authorization
headers on requests coming from the frontend. This is accomplished using
ExpressJS-provided middleware, configured for this scenario. Much of
this functionality is abstracted away by the express-jwt library, but
there are two interesting things to note:</p>
<ul>
<li>For this application, the only valid way to send authorization with
a request, is in the Authorization header. Thus, if a JWT is sent as a
query parameter on a request, the request will be rejected as
unauthorized.</li>
</ul>
<div class="sourceCode" id="cb7"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">fromHeader</span>(req) {</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (req<span class="op">.</span><span class="at">headers</span><span class="op">.</span><span class="at">authorization</span> <span class="op">&amp;&amp;</span> req<span class="op">.</span><span class="at">headers</span><span class="op">.</span><span class="at">authorization</span><span class="op">.</span><span class="fu">toLowerCase</span>()<span class="op">.</span><span class="fu">startsWith</span>(<span class="st">&#39;bearer &#39;</span>)) {</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Require &#39;Bearer &#39; in header</span></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> retval <span class="op">=</span> req<span class="op">.</span><span class="at">headers</span><span class="op">.</span><span class="at">authorization</span><span class="op">.</span><span class="fu">split</span>(<span class="st">&#39; &#39;</span><span class="op">,</span> <span class="dv">2</span>)[<span class="dv">1</span>]</span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> retval</span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> <span class="kw">null</span></span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<ul>
<li>Some REST endpoints are required to <strong>NOT</strong> contain an
Authorization header, as they return information that is either required
before authentication with Google has been established, or they return
public content that should be accessible by anyone. These special cases
are explicitly exempted from the checks provided by the middleware.</li>
</ul>
<div class="sourceCode" id="cb8"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>module<span class="op">.</span><span class="at">exports</span> <span class="op">=</span> authConfig <span class="kw">=&gt;</span> {</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> <span class="fu">jwt</span>({</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>    <span class="dt">secret</span><span class="op">:</span> authConfig<span class="op">.</span><span class="at">signingKey</span><span class="op">,</span></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>    <span class="dt">getToken</span><span class="op">:</span> fromHeader<span class="op">,</span></span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>    <span class="dt">algorithms</span><span class="op">:</span> [<span class="st">&#39;HS256&#39;</span>]</span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>  })<span class="op">.</span><span class="fu">unless</span>({</span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Restrict all the end points that can return secured data</span></span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a>    <span class="dt">path</span><span class="op">:</span> [<span class="st">&#39;/auth/login&#39;</span><span class="op">,</span> <span class="st">&#39;/auth/config&#39;</span><span class="op">,</span> <span class="st">&#39;/unsecured&#39;</span>]</span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div></li>
</ul>
<p>For full implementation details, see
nodejs-backend/routes/auth.js.</p>
<h2 id="validation">Validation</h2>
<p>The only thing left to do is to test the implementation.</p>
<ul>
<li>Unauthorized users are restricted from seeing secured content,
through both the user interface and the backend server. To test this:
<ul>
<li>Start the application.</li>
<li>Notice on the Home screen that the “Display Secured Content” button
is disabled.</li>
<li>Attempt to navigate to http://localhost:3000/secured? (to get
secured content back from the endpoint directly). Notice that “Internal
Server Error” is shown in the main user interface, and, in the Developer
Tools -&gt; Network tab, the request failed with a 401 (Unauthorized)
error.</li>
</ul></li>
<li>Authorized users have access to secured content. To test this:
<ul>
<li>Log in using the “Continue with Google” button and valid Google
account credentials.</li>
<li>Notice that the “Continue with Google” button has been replaced with
account-specific user information.</li>
<li>Notice that the “Display Secured Content” button is now
enabled.</li>
<li>Click the button and notice that secured content is now displayed in
the main text area.</li>
</ul></li>
</ul>
</body>
</html>
